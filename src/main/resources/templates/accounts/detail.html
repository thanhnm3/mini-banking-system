<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head(title='Chi tiết tài khoản - Mini Banking')}"></head>
<body>
  <div th:replace="~{layout :: header}"></div>

  <main class="container py-4">
    <div th:replace="~{layout :: alerts}"></div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#" id="userLink">Khách hàng</a></li>
        <li class="breadcrumb-item active" id="breadcrumb">Tài khoản</li>
      </ol>
    </nav>
    <h1 class="mb-4">Chi tiết tài khoản</h1>
    <p class="text-muted small">Mở DevTools (F12) → Network → XHR để xem API calls.</p>

    <div id="loading" class="text-center py-4 text-muted">Đang tải...</div>
    <div id="content" style="display: none">
      <div class="card mb-4">
        <div class="card-header">Thông tin tài khoản</div>
        <div class="card-body">
          <dl class="row" id="accountInfo"></dl>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Lịch sử giao dịch</div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Loại</th>
                <th>Số tiền</th>
                <th>Mô tả</th>
                <th>Trạng thái</th>
                <th>Thời gian</th>
              </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div th:replace="~{layout :: footer}"></div>
  <div th:replace="~{layout :: scripts}"></div>

  <script th:inline="javascript">
    (function() {
      const API_BASE = /*[[@{/api/v1}]]*/ '/api/v1';
      const id = /*[[${id}]]*/ 0;
      const fmt = (n) => n ? Number(n).toLocaleString('vi-VN', {minimumFractionDigits: 2}) : '0';
      const fmtDate = (d) => d ? new Date(d).toLocaleString('vi-VN') : '';

      Promise.all([
        fetch(API_BASE + '/accounts/' + id).then(r => r.json()),
        fetch(API_BASE + '/transactions/account/' + id).then(r => r.json())
      ]).then(([accountRes, txRes]) => {
        document.getElementById('loading').style.display = 'none';
        const content = document.getElementById('content');
        if (accountRes.success && accountRes.data) {
          const a = accountRes.data;
          document.getElementById('breadcrumb').textContent = a.accountNumber || '';
          document.getElementById('userLink').href = '/pages/users/' + a.userId;
          document.getElementById('accountInfo').innerHTML = `
            <dt class="col-sm-2">Số tài khoản</dt><dd class="col-sm-10">${a.accountNumber || ''}</dd>
            <dt class="col-sm-2">Loại</dt><dd class="col-sm-10">${a.accountType || ''}</dd>
            <dt class="col-sm-2">Số dư</dt><dd class="col-sm-10">${fmt(a.balance)} ${a.currency || ''}</dd>
            <dt class="col-sm-2">Trạng thái</dt><dd class="col-sm-10">${a.status || ''}</dd>
          `;
        }
        if (txRes.success && txRes.data) {
          txRes.data.forEach(tx => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${tx.id || ''}</td>
              <td>${tx.type || ''}</td>
              <td>${fmt(tx.amount)}</td>
              <td>${tx.description || ''}</td>
              <td>${tx.status || ''}</td>
              <td>${fmtDate(tx.createdAt)}</td>
            `;
            document.getElementById('transactionsBody').appendChild(tr);
          });
        }
        if (txRes.success && (!txRes.data || txRes.data.length === 0)) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="6" class="text-center text-muted">Chưa có giao dịch</td>';
          document.getElementById('transactionsBody').appendChild(tr);
        }
        content.style.display = 'block';
      }).catch(err => {
        document.getElementById('loading').textContent = 'Lỗi: ' + err.message;
      });
    })();
  </script>
</body>
</html>
